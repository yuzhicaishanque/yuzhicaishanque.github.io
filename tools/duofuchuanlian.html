<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>åŒ–å·¥å®éªŒæ•°æ®å¤„ç†å·¥å…·</title>
    <link rel="stylesheet" href="https://registry.npmmirror.com/@stlite/mountable/0.50.0/files/build/stlite.css" />
    <style>
      /* âœ… ä¼˜åŒ–2: åŠ è½½åŠ¨ç”» */
      #loader {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; z-index: 9999;
        font-family: sans-serif;
      }
      .spinner {
        border: 6px solid #f3f3f3; border-top: 6px solid #00aeef; border-radius: 50%;
        width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px auto;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .loading-text { color: #333; font-weight: bold; }
      .loading-sub { color: #888; font-size: 12px; margin-top: 5px; }
    </style>
  </head>
  <body>
    <div id="root" style="height: 100vh;"></div>

    <div id="loader">
      <div class="spinner"></div>
      <div class="loading-text">ğŸš€ æ­£åœ¨è£…è½½ Python å¼•æ“...</div>
      <div class="loading-sub">é¦–æ¬¡è¿è¡Œè¾ƒæ…¢ï¼Œåç»­ç§’å¼€</div>
    </div>

    <script src="https://registry.npmmirror.com/@stlite/mountable/0.50.0/files/build/stlite.js"></script>

    <script>
      stlite.mount({
        // âœ… ä¼˜åŒ–3: å»æ‰äº† 'scipy'ï¼Œä½“ç§¯å‡å° 40%
        requirements: ["streamlit", "pandas", "numpy", "matplotlib", "xlsxwriter"],
        entrypoint: "streamlit_app.py",
        files: {
          files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm  # âœ… å¼•å…¥å­—ä½“ç®¡ç†
import math
import io
import os
import warnings

# --- å…¼å®¹æ€§è®¾ç½® ---
if hasattr(np, 'trapezoid'):
    trapezoid = np.trapezoid
else:
    trapezoid = np.trapz

warnings.filterwarnings('ignore')

# ==========================================
# ğŸ…°ï¸ æ ¸å¿ƒä¿®å¤ï¼šåŠ è½½ä¸­æ–‡å­—ä½“
# ==========================================
@st.cache_resource  # ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…æ¯æ¬¡åˆ·æ–°éƒ½é‡æ–°ä¸‹è½½
def load_chinese_font():
    # å­—ä½“æ–‡ä»¶å
    font_name = "simhei.ttf"
    
    # 1. æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ (å› ä¸º pyodide æ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ)
    if not os.path.exists(font_name):
        # å¦‚æœä¸å­˜åœ¨ï¼Œé€šè¿‡ open_url è¯»å–å½“å‰ç›®å½•ä¸‹çš„å­—ä½“æ–‡ä»¶
        # æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ simhei.ttf å°±åœ¨ç½‘é¡µçš„åŒä¸€çº§ç›®å½•ä¸‹
        from pyodide.http import open_url
        try:
            # ä¸‹è½½å­—ä½“åˆ°è™šæ‹Ÿå†…å­˜
            with open_url(font_name) as f:
                content = f.read()
            # å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
            with open(font_name, "wb") as f:
                f.write(content)
        except Exception as e:
            st.error(f"å­—ä½“åŠ è½½å¤±è´¥: {e}")
            return None

    # 2. æ³¨å†Œå­—ä½“
    if os.path.exists(font_name):
        fm.fontManager.addfont(font_name)
        # è·å–æ³¨å†Œåçš„å­—ä½“å¯¹è±¡
        prop = fm.FontProperties(fname=font_name)
        # è®¾ç½®å…¨å±€é»˜è®¤å­—ä½“
        plt.rcParams['font.family'] = prop.get_name()
        plt.rcParams['axes.unicode_minus'] = False # è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜
        return prop
    return None

# æ‰§è¡ŒåŠ è½½å­—ä½“
chinese_font = load_chinese_font()

# ==========================================
# ğŸ…±ï¸ æ ¸å¿ƒé€»è¾‘ (ä¿æŒä¸å˜)
# ==========================================

st.set_page_config(page_title="å¤šé‡œä¸²è”å¤„ç†", layout="wide", page_icon="âš—ï¸")

# ... (çœç•¥ä¸­é—´çš„æ•°æ®å¤„ç†å‡½æ•° get_theoretical_E, process_uploaded_file ç­‰ï¼Œä¿æŒåŸæ ·å³å¯) ...

def get_theoretical_E(t, tau, N):
    if N < 1: N = 1
    if tau == 0: return np.zeros_like(t)
    with np.errstate(divide='ignore', invalid='ignore'):
        coeff = (N**N) / (tau**N * math.gamma(N))
        term = t**(N-1)
        exp_term = np.exp(-N * t / tau)
        E = coeff * term * exp_term
    E[np.isnan(E)] = 0
    return E

def sample_dataframe(df, num_points=25):
    if len(df) <= num_points: return df
    indices = np.linspace(0, len(df) - 1, num_points, dtype=int)
    indices = sorted(list(set(indices)))
    return df.iloc[indices].copy()

def process_uploaded_file(uploaded_file, col_target, label):
    try:
        try:
            df = pd.read_csv(uploaded_file, delimiter=';', encoding='utf-8')
        except:
            uploaded_file.seek(0)
            df = pd.read_csv(uploaded_file, delimiter=';', encoding='gbk')
        if len(df.columns) < 2:
            uploaded_file.seek(0)
            df = pd.read_csv(uploaded_file, delimiter=',')
    except Exception as e:
        return None, None, None, f"è¯»å–å¤±è´¥: {e}"

    time_col = df.columns[0]
    try:
        df['Time_Obj'] = pd.to_datetime(df[time_col])
    except:
        df['Time_Obj'] = pd.to_datetime(df[time_col], dayfirst=True, errors='coerce')

    start_t = df['Time_Obj'].iloc[0]
    t_arr = (df['Time_Obj'] - start_t).dt.total_seconds().values
    
    idx_map = {'1å·é‡œ': 1, '2å·é‡œ': 2, '3å·é‡œ': 3, '4å·é‡œ': 4}
    target_idx = -1
    
    if col_target in df.columns:
        raw_C = df[col_target].values
    else:
        for k, v in idx_map.items():
            if k in label:
                target_idx = v
                break
        if target_idx != -1 and target_idx < len(df.columns):
            raw_C = df.iloc[:, target_idx].values
        else:
            return None, None, None, f"æ‰¾ä¸åˆ°åˆ—: {col_target}"

    baseline = raw_C[0]
    net_C = np.maximum(raw_C - baseline, 0)
    area = trapezoid(net_C, t_arr)
    moment_1 = trapezoid(t_arr * net_C, t_arr)
    t_mean = moment_1 / area if area != 0 else 0
    moment_2 = trapezoid(t_arr**2 * net_C, t_arr)
    variance = (moment_2 / area) - t_mean**2 if area != 0 else 0
    N_model = (t_mean**2) / variance if variance != 0 else 0
    E_t = net_C / area if area != 0 else np.zeros_like(net_C)
    full_df = pd.DataFrame({'åŸå§‹æ—¶é—´': df[time_col], 'æ—¶é—´ (s)': t_arr, 'ç”µå¯¼ç‡åŸå§‹å€¼': raw_C, 'ç”µå¯¼ç‡(å‡€)': net_C, 'C*t': net_C * t_arr, 'C*t^2': net_C * (t_arr**2)})
    sampled = sample_dataframe(full_df, 25)
    stats = {'sum_C': area, 'sum_Ct': moment_1, 'sum_Ct2': moment_2, 't_mean': t_mean, 'variance': variance, 'N_model': N_model}
    return sampled, t_arr, E_t, stats

# --- ç•Œé¢éƒ¨åˆ† ---
st.title("âš—ï¸ å¤šé‡œä¸²è”æ•°æ®å¤„ç† (ä¸­æ–‡åŒ–ä¿®å¤ç‰ˆ)")

if not chinese_font:
    st.warning("âš ï¸ æœªæ£€æµ‹åˆ°ä¸­æ–‡å­—ä½“æ–‡ä»¶ (simhei.ttf)ï¼Œå›¾è¡¨ä¸­æ–‡å¯èƒ½æ— æ³•æ˜¾ç¤ºã€‚è¯·ç¡®ä¿å°† ttf æ–‡ä»¶æ”¾åœ¨åŒç›®å½•ä¸‹ã€‚")

with st.sidebar:
    st.header("âš™ï¸ å‚æ•°")
    vol_input = st.number_input("ä½“ç§¯ V (mL)", value=1040.0)
    flow_input = st.number_input("æµé‡ Q (mL/min)", value=225.0)
    if flow_input != 0:
        theo_tau = (vol_input / flow_input) * 60
    else:
        theo_tau = 0
    st.info(f"Ï„ = {theo_tau:.2f} s")
    st.divider()
    st.header("ğŸ“‚ æ•°æ®")
    file_600 = st.file_uploader("600 rpm (å¿…å¡«)", type=['csv'])
    file_300 = st.file_uploader("300 rpm (å¯é€‰)", type=['csv'])
    file_0 = st.file_uploader("0 rpm (å¯é€‰)", type=['csv'])
    process_btn = st.button("ğŸš€ å¼€å§‹å¤„ç†", type="primary")

if process_btn:
    if not file_600:
        st.error("è¯·å…ˆä¸Šä¼  600 rpm æ•°æ®")
    else:
        output = io.BytesIO()
        writer = pd.ExcelWriter(output, engine='xlsxwriter')
        results_cache = {}
        
        tasks = [
            (file_600, '1#é‡œç”µå¯¼ç‡å€¼', 1, '1å·é‡œ (600 rpm)', '600rpm_1'),
            (file_600, '2#é‡œç”µå¯¼ç‡å€¼', 2, '2å·é‡œ (600 rpm)', '600rpm_2'),
            (file_600, '3#é‡œç”µå¯¼ç‡å€¼', 3, '3å·é‡œ (600 rpm)', '600rpm_3'),
            (file_600, '4#é‡œç”µå¯¼ç‡å€¼', 4, '4å·é‡œ (600 rpm)', '600rpm_4'),
            (file_300, '1#é‡œç”µå¯¼ç‡å€¼', 1, '1å·é‡œ (300 rpm)', '300rpm_1'),
            (file_0,   '1#é‡œç”µå¯¼ç‡å€¼', 1, '1å·é‡œ (0 rpm)',   '0rpm_1')
        ]
        
        for i, (f_obj, col, theo_N, label, sheet) in enumerate(tasks):
            if f_obj is None: continue
            f_obj.seek(0)
            sampled, t_full, E_full, stats = process_uploaded_file(f_obj, col, label)
            if sampled is None:
                st.warning(f"{label} å¤±è´¥: {stats}")
                continue
            
            results_cache[label] = {'t': t_full, 'E': E_full, 'stats': stats}
            
            # Excel å†™å…¥ç®€ç•¥ç‰ˆ
            summary = pd.DataFrame([['N_model', f"{stats['N_model']:.2f}"], ['Variance', f"{stats['variance']:.2f}"]])
            sampled.to_excel(writer, sheet_name=sheet, index=False)
            summary.to_excel(writer, sheet_name=sheet, startcol=6, index=False)

        writer.close()
        st.success("âœ… å¤„ç†å®Œæˆ")
        st.download_button("ğŸ“¥ ä¸‹è½½ Excel", data=output.getvalue(), file_name="result.xlsx")

        st.subheader("ğŸ“Š ç»“æœé¢„è§ˆ")
        tab1, tab2 = st.tabs(["è½¬é€Ÿå¯¹æ¯”", "è¯¦ç»†åˆ†å¸ƒ"])
        
        with tab1:
            fig, ax = plt.subplots(figsize=(8, 4))
            for k, v in results_cache.items():
                if "1å·é‡œ" in k:
                    ax.plot(v['t'], v['E'], label=k)
            # âœ… ä¿®å¤ï¼šæ·»åŠ åæ ‡è½´æ ‡ç­¾
            ax.set_xlabel("æ—¶é—´ t (s)", fontsize=12)
            ax.set_ylabel("E(t) åˆ†å¸ƒ", fontsize=12)
            ax.legend()
            st.pyplot(fig)
            
        with tab2:
            st.subheader("600 rpm å„é‡œåˆ†å¸ƒ")
            col1, col2 = st.columns(2)
            cols = [col1, col2, col1, col2]
            targets = [('1å·é‡œ (600 rpm)', 1), ('2å·é‡œ (600 rpm)', 2),
                       ('3å·é‡œ (600 rpm)', 3), ('4å·é‡œ (600 rpm)', 4)]
            
            for i, (key, theo_N) in enumerate(targets):
                if key in results_cache:
                    with cols[i]:
                        d = results_cache[key]
                        fig, ax = plt.subplots(figsize=(5, 3))
                        ax.plot(d['t'], d['E'], label='å®æµ‹')
                        t_ref = np.linspace(0, d['t'].max(), 500)
                        E_theo = get_theoretical_E(t_ref, d['stats']['t_mean'], theo_N)
                        ax.plot(t_ref, E_theo, 'k--', label=f'ç†è®ºN={theo_N}')
                        
                        ax.set_title(f"{key} (N={d['stats']['N_model']:.2f})", fontsize=10)
                        # âœ… ä¿®å¤ï¼šæ·»åŠ åæ ‡è½´æ ‡ç­¾
                        ax.set_xlabel("æ—¶é—´ t (s)")
                        ax.set_ylabel("E(t)")
                        
                        ax.legend(fontsize=8)
                        st.pyplot(fig)
`
        },
      }, document.getElementById("root")).then(() => {
        // éšè—åŠ è½½åŠ¨ç”»
        document.getElementById("loader").style.display = "none";
      });
    </script>
  </body>
</html>