<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šé‡œä¸²è”å®éªŒæ•°æ®å¤„ç† (JSæé€Ÿç‰ˆ)</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/plotly.js/2.24.1/plotly.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f6; display: flex; height: 100vh; }
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar { width: 300px; background-color: #ffffff; padding: 20px; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .sidebar h2 { font-size: 1.2rem; color: #31333F; margin-bottom: 15px; border-bottom: 2px solid #ff4b4b; padding-bottom: 5px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; color: #31333F; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-primary { background-color: #ff4b4b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1rem; transition: background 0.3s; margin-top: 10px; }
        .btn-primary:hover { background-color: #d93e3e; }
        .btn-download { background-color: #0083B8; margin-top: 20px; display: none; } /* é»˜è®¤éšè—ä¸‹è½½æŒ‰é’® */
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { margin-bottom: 30px; }
        .header h1 { margin: 0; color: #0e1117; }
        .header p { color: #808495; }
        
        /* å¡ç‰‡å®¹å™¨ */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .chart-container { width: 100%; height: 500px; }
        
        /* ç®€å•çš„åŠ è½½é®ç½© */
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; color: #ff4b4b; }
    </style>
</head>
<body>

<div id="loading">ğŸš€ æ­£åœ¨è®¡ç®—ä¸­...</div>

<div class="sidebar">
    <h2>âš™ï¸ å‚æ•°è®¾ç½®</h2>
    <div class="input-group">
        <label>æœ‰æ•ˆä½“ç§¯ V (mL)</label>
        <input type="number" id="vol" value="1040.0">
    </div>
    <div class="input-group">
        <label>æµé‡ Q (mL/min)</label>
        <input type="number" id="flow" value="225.0">
    </div>
    <div class="input-group" style="background: #e8f0fe; padding: 10px; border-radius: 5px;">
        <label>ç†è®ºåœç•™æ—¶é—´ Ï„ (s)</label>
        <div id="theo_tau" style="font-size: 1.2rem; font-weight: bold; color: #0068c9;">277.33</div>
    </div>

    <h2>ğŸ“‚ æ•°æ®ä¸Šä¼  (CSV)</h2>
    <div class="input-group">
        <label>600 rpm (å¿…é¡»)</label>
        <input type="file" id="file_600" accept=".csv">
    </div>
    <div class="input-group">
        <label>300 rpm (å¯é€‰)</label>
        <input type="file" id="file_300" accept=".csv">
    </div>
    <div class="input-group">
        <label>0 rpm (å¯é€‰)</label>
        <input type="file" id="file_0" accept=".csv">
    </div>

    <button class="btn-primary" onclick="startProcess()">ğŸš€ å¼€å§‹å¤„ç†</button>
    <button class="btn-primary btn-download" id="btn_download" onclick="downloadExcel()">ğŸ“¥ ä¸‹è½½ Excel ç»“æœ</button>
</div>

<div class="main">
    <div class="header">
        <h1>âš—ï¸ å¤šé‡œä¸²è”å®éªŒæ•°æ®å¤„ç† (JS æé€Ÿç‰ˆ)</h1>
        <p>åŸºäº JavaScript åŸç”Ÿè®¡ç®—ï¼Œæ— éœ€ä¸Šä¼ æœåŠ¡å™¨ï¼Œç§’çº§å‡ºå›¾ï¼Œæ”¯æŒé«˜æ¸…å¯¼å‡ºã€‚</p>
    </div>

    <div class="card">
        <h3>ğŸ“Š 1å·é‡œä¸åŒè½¬é€Ÿ E(t) å¯¹æ¯”</h3>
        <div id="chart_compare" class="chart-container"></div>
    </div>

    <div class="card" id="detail_container" style="display:none;">
        <h3>ğŸ“ˆ 600 rpm å„é‡œæ¨¡å‹æ‹Ÿåˆè¯¦æƒ…</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div id="chart_detail_1" style="height: 350px;"></div>
            <div id="chart_detail_2" style="height: 350px;"></div>
            <div id="chart_detail_3" style="height: 350px;"></div>
            <div id="chart_detail_4" style="height: 350px;"></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. æ•°å­¦å·¥å…·åº“ (æ›¿ä»£ Numpy/Scipy)
    // ==========================================
    
    // æ¢¯å½¢ç§¯åˆ† (å¯¹åº” np.trapz)
    function trapz(y, x) {
        let sum = 0;
        for (let i = 0; i < x.length - 1; i++) {
            sum += 0.5 * (y[i+1] + y[i]) * (x[i+1] - x[i]);
        }
        return sum;
    }

    // Gamma å‡½æ•° (Lanczosè¿‘ä¼¼ï¼Œæ›¿ä»£ math.gamma)
    function gamma(z) {
        if (z < 0.5) return Math.PI / (Math.sin(Math.PI * z) * gamma(1 - z));
        z -= 1;
        let x = 0.99999999999980993;
        let p = [676.5203681218851, -1259.1392167224028, 771.32342877765313, -176.61502916214059, 12.507343278686905, -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
        for (let i = 0; i < p.length; i++) x += p[i] / (z + i + 1);
        let t = z + p.length - 0.5;
        return Math.sqrt(2 * Math.PI) * Math.pow(t, z + 0.5) * Math.exp(-t) * x;
    }

    // ç†è®º E(t) è®¡ç®—
    function getTheoreticalE(tArr, tau, N) {
        if (N < 1) N = 1;
        if (tau === 0) return tArr.map(() => 0);
        
        const coeff = (Math.pow(N, N)) / (Math.pow(tau, N) * gamma(N));
        return tArr.map(t => {
            if (t < 0) return 0;
            return coeff * Math.pow(t, N - 1) * Math.exp(-N * t / tau);
        });
    }

    // ==========================================
    // 2. ä¸šåŠ¡é€»è¾‘
    // ==========================================

    // å…¨å±€å˜é‡å­˜å‚¨å¤„ç†åçš„æ•°æ®ï¼Œç”¨äºå¯¼å‡º Excel
    let globalResults = {}; 

    // è‡ªåŠ¨æ›´æ–°ç†è®º Tau
    document.querySelectorAll('#vol, #flow').forEach(el => {
        el.addEventListener('input', () => {
            const V = parseFloat(document.getElementById('vol').value);
            const Q = parseFloat(document.getElementById('flow').value);
            const tau = Q === 0 ? 0 : (V / Q) * 60;
            document.getElementById('theo_tau').innerText = tau.toFixed(2);
        });
    });

    async function startProcess() {
        const file600 = document.getElementById('file_600').files[0];
        const file300 = document.getElementById('file_300').files[0];
        const file0 = document.getElementById('file_0').files[0];

        if (!file600) { alert("âŒ è¯·è‡³å°‘ä¸Šä¼  600 rpm çš„æ•°æ®æ–‡ä»¶ï¼"); return; }

        document.getElementById('loading').style.display = 'flex';
        globalResults = {}; // æ¸…ç©ºæ—§æ•°æ®

        const V = parseFloat(document.getElementById('vol').value);
        const Q = parseFloat(document.getElementById('flow').value);
        const theoTau = (V / Q) * 60;

        try {
            // å®šä¹‰ä»»åŠ¡åˆ—è¡¨
            const tasks = [
                { file: file600, colName: '1å·é‡œ', theoN: 1, rpm: '600' },
                { file: file600, colName: '2å·é‡œ', theoN: 2, rpm: '600' },
                { file: file600, colName: '3å·é‡œ', theoN: 3, rpm: '600' },
                { file: file600, colName: '4å·é‡œ', theoN: 4, rpm: '600' },
                { file: file300, colName: '1å·é‡œ', theoN: 1, rpm: '300' },
                { file: file0,   colName: '1å·é‡œ', theoN: 1, rpm: '0' }
            ];

            // ç»˜å›¾æ•°æ®å®¹å™¨
            const compareTraces = [];
            
            // å¾ªç¯å¤„ç†æ¯ä¸ªä»»åŠ¡
            for (let task of tasks) {
                if (!task.file) continue;

                // 1. è¯»å– CSV (ä½¿ç”¨ Promise å°è£… FileReader)
                const text = await readFileAsText(task.file);
                
                // 2. è§£æ CSV (PapaParse)
                const parseResult = Papa.parse(text, { 
                    header: true, 
                    dynamicTyping: true, 
                    skipEmptyLines: true,
                    encoding: "GBK" // å°è¯• GBK è¯»å–
                });
                
                let data = parseResult.data;
                let meta = parseResult.meta;

                // ç®€å•çš„å®¹é”™ï¼šå¦‚æœ GBK è¯»å‡ºæ¥ä¹±ç æˆ–è€…åªæœ‰1åˆ—ï¼Œå¯èƒ½åˆ†éš”ç¬¦ä¸å¯¹
                if (meta.fields.length < 2) {
                     // ç®€å•ç²—æš´å¤„ç†ï¼šå¦‚æœ CSV è§£æå¤±è´¥ï¼Œç”¨æˆ·éœ€å¦å­˜ä¸º UTF-8ï¼Œ
                     // è¿™é‡Œå‡è®¾ PapaParse è¶³å¤Ÿå¼ºå¤§ï¼Œé€šå¸¸èƒ½è‡ªåŠ¨è¯†åˆ«åˆ†éš”ç¬¦
                }

                // 3. æå–åˆ—æ•°æ®
                // å¯»æ‰¾æ—¶é—´åˆ— (é€šå¸¸æ˜¯ç¬¬1åˆ—)
                const timeKey = meta.fields[0];
                // å¯»æ‰¾ç›®æ ‡åˆ— (æ¨¡ç³ŠåŒ¹é… '1å·é‡œ' ç­‰)
                const targetKey = meta.fields.find(f => f.includes(task.colName));

                if (!targetKey) { console.warn(`æ‰¾ä¸åˆ°åˆ—: ${task.colName}`); continue; }

                // æ•°æ®é¢„å¤„ç†ï¼šè½¬ä¸ºçº¯æ•°ç»„ï¼Œå¤„ç†æ—¶é—´
                let rawT = [], rawC = [];
                // å‡è®¾æ—¶é—´æ ¼å¼æ˜¯ "yyyy/mm/dd HH:MM:SS" æˆ–ç›´æ¥æ˜¯ç§’
                const startTime = new Date(data[0][timeKey]).getTime();
                
                data.forEach(row => {
                    if (row[timeKey] && row[targetKey] !== undefined) {
                        // è®¡ç®—ç§’æ•°å·®
                        let t_sec = (new Date(row[timeKey]).getTime() - startTime) / 1000;
                        if(isNaN(t_sec)) t_sec = parseFloat(row[timeKey]); // å‡å¦‚æœ¬èº«å°±æ˜¯ç§’

                        rawT.push(t_sec);
                        rawC.push(row[targetKey]);
                    }
                });

                // 4. æ ¸å¿ƒè®¡ç®— (JS å¤åˆ» Python é€»è¾‘)
                const baseline = rawC[0];
                const netC = rawC.map(c => Math.max(c - baseline, 0));
                
                const area = trapz(netC, rawT);
                const moment1 = trapz(rawT.map((t, i) => t * netC[i]), rawT);
                const tMean = area !== 0 ? moment1 / area : 0;
                
                const moment2 = trapz(rawT.map((t, i) => t*t * netC[i]), rawT);
                const variance = area !== 0 ? (moment2 / area) - tMean*tMean : 0;
                const N_model = variance !== 0 ? (tMean*tMean) / variance : 0;

                const E_t = area !== 0 ? netC.map(c => c / area) : netC.map(() => 0);

                // å­˜å…¥å…¨å±€ç»“æœ
                const key = `${task.colName} (${task.rpm} rpm)`;
                globalResults[key] = {
                    t: rawT, E: E_t, rawC: rawC, netC: netC,
                    stats: { tMean, variance, N_model, area },
                    theoN: task.theoN
                };

                // æ·»åŠ å¯¹æ¯”å›¾æ•°æ® (ä»…1å·é‡œ)
                if (task.colName === '1å·é‡œ') {
                    compareTraces.push({
                        x: rawT, y: E_t, mode: 'lines', name: `${task.rpm} rpm å®æµ‹`,
                        line: { width: 2 }
                    });
                }
            }

            // ==========================================
            // 5. ç»˜å›¾ (Plotly.js)
            // ==========================================
            
            // å›¾1ï¼šè½¬é€Ÿå¯¹æ¯”
            const maxT = Math.max(...compareTraces[0].x);
            const tRef = Array.from({length: 500}, (_, i) => i * maxT / 499);
            const ERef = getTheoreticalE(tRef, theoTau, 1);
            
            compareTraces.push({
                x: tRef, y: ERef, mode: 'lines', name: 'ç†è®ºå…¨æ··æµ (N=1)',
                line: { color: 'black', dash: 'dash', width: 1.5 }
            });

            const layoutCommon = {
                font: { family: "Microsoft YaHei, sans-serif" }, // åŸç”Ÿæ”¯æŒä¸­æ–‡
                xaxis: { title: 'æ—¶é—´ t (s)' },
                yaxis: { title: 'E(t)' },
                hovermode: 'x unified',
                template: 'simple_white',
                margin: { t: 40, r: 20, b: 40, l: 50 }
            };

            const configDl = {
                toImageButtonOptions: { format: 'png', filename: 'è½¬é€Ÿå¯¹æ¯”', height: 600, width: 800, scale: 3 },
                displayModeBar: true, displaylogo: false
            };

            Plotly.newPlot('chart_compare', compareTraces, {...layoutCommon, title: '1å·é‡œä¸åŒè½¬é€Ÿ E(t) å¯¹æ¯”'}, configDl);

            // å›¾2ï¼šè¯¦ç»†æ‹Ÿåˆ (600 rpm çš„ 4 ä¸ªé‡œ)
            document.getElementById('detail_container').style.display = 'block';
            
            const detailKeys = ['1å·é‡œ (600 rpm)', '2å·é‡œ (600 rpm)', '3å·é‡œ (600 rpm)', '4å·é‡œ (600 rpm)'];
            detailKeys.forEach((k, idx) => {
                if (globalResults[k]) {
                    const res = globalResults[k];
                    // ç†è®ºæ›²çº¿
                    const ETheo = getTheoreticalE(tRef, res.stats.tMean, res.theoN);
                    
                    const traces = [
                        { x: res.t, y: res.E, mode: 'lines', name: 'å®æµ‹', line: {width: 2} },
                        { x: tRef, y: ETheo, mode: 'lines', name: `ç†è®ºN=${res.theoN}`, line: {color:'black', dash:'dash'} }
                    ];
                    
                    const title = `${k} (N=${res.stats.N_model.toFixed(2)})`;
                    Plotly.newPlot(`chart_detail_${idx+1}`, traces, 
                        {...layoutCommon, title: title, height: 350, margin: {t:40,b:30,l:40,r:10}}, 
                        {...configDl, toImageButtonOptions: {...configDl.toImageButtonOptions, filename: k}}
                    );
                }
            });

            document.getElementById('btn_download').style.display = 'block';

        } catch (err) {
            console.error(err);
            alert("å¤„ç†å‡ºé”™ï¼š" + err.message + "\nè¯·æ£€æŸ¥CSVæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // è¯»å–æ–‡ä»¶çš„è¾…åŠ©å‡½æ•°
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            // é»˜è®¤å°è¯• GBK è¯»å–ï¼Œé€‚åº”ä¸­æ–‡ Excel CSV
            reader.readAsText(file, 'GBK'); 
        });
    }

    // ==========================================
    // 6. Excel å¯¼å‡º (SheetJS)
    // ==========================================
    function downloadExcel() {
        const wb = XLSX.utils.book_new();

        // éå†æ‰€æœ‰ç»“æœï¼Œæ¯ä¸ªç»“æœä¸€ä¸ª Sheet
        for (let [sheetName, res] of Object.entries(globalResults)) {
            // å‡†å¤‡è¡¨å¤´æ•°æ®
            const sheetData = [
                ['åŸå§‹æ—¶é—´', 'æ—¶é—´(s)', 'ç”µå¯¼ç‡åŸå§‹', 'ç”µå¯¼ç‡(å‡€)', 'C*t', 'C*t^2', ' ', 'ç»Ÿè®¡é¡¹', 'æ•°å€¼']
            ];

            // å¡«å……æ•°æ®è¡Œ
            for (let i = 0; i < res.t.length; i++) {
                let row = [
                    '-', // åŸå§‹æ—¶é—´æš‚ä¸å›å¡«
                    res.t[i],
                    res.rawC[i],
                    res.netC[i],
                    res.netC[i] * res.t[i],
                    res.netC[i] * res.t[i] * res.t[i],
                    '', // ç©ºåˆ—
                ];

                // åœ¨å³ä¾§å¡«å……ç»Ÿè®¡æ•°æ® (ä»…å‰å‡ è¡Œ)
                if (i === 0) row.push('å¹³å‡åœç•™æ—¶é—´', res.stats.tMean);
                if (i === 1) row.push('æ–¹å·®', res.stats.variance);
                if (i === 2) row.push('æ¨¡æ‹Ÿçº§æ•° N', res.stats.N_model);
                if (i === 3) row.push('ç§¯åˆ†é¢ç§¯', res.stats.area);

                sheetData.push(row);
            }
            
            // åªæœ‰å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ä¸­æ–‡èƒ½åš sheet åï¼Œæ¸…ç†ä¸€ä¸‹ç‰¹æ®Šå­—ç¬¦
            const safeName = sheetName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '_').substring(0, 30);
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, safeName);
        }

        XLSX.writeFile(wb, "å¤šé‡œä¸²è”å®éªŒç»“æœ.xlsx");
    }
</script>

</body>
</html>