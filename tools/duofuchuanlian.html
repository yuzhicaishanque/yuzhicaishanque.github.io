<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>åŒ–å·¥å·¥å…·é€šç”¨æ¨¡æ¿</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.50.0/build/stlite.css" />
  </head>
  <body>
    <div id="root" style="height: 100vh;"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.50.0/build/stlite.js"></script>

    <script>
      stlite.mount({
        // ğŸ‘‡ ä¿®æ”¹ 2ï¼šå¦‚æœä½ ç”¨äº†ç‰¹æ®Šçš„åº“ï¼ˆæ¯”å¦‚ sympyï¼‰ï¼Œåœ¨è¿™é‡ŒåŠ 
        requirements: ["streamlit", "pandas", "numpy", "matplotlib", "scipy", "xlsxwriter"],
        entrypoint: "streamlit_app.py",
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# ==========================================
# ğŸ‘‡ ä¿®æ”¹ 3ï¼šåœ¨è¿™é‡Œç²˜è´´ä½ çš„ Python ä»£ç 
# ==========================================

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy.special import gamma
import io
import warnings

# --- å…¼å®¹æ€§è®¾ç½® ---
try:
    from scipy.integrate import trapezoid
except ImportError:
    if hasattr(np, 'trapezoid'):
        trapezoid = np.trapezoid
    else:
        trapezoid = np.trapz

warnings.filterwarnings('ignore')

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="å¤šé‡œä¸²è”å®éªŒæ•°æ®å¤„ç†", layout="wide", page_icon="âš—ï¸")

# --- ç»˜å›¾å­—ä½“è®¾ç½® ---
import matplotlib.font_manager as fm
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['font.sans-serif'] = ['Microsoft YaHei', 'SimHei', 'Arial']
plt.rcParams['axes.unicode_minus'] = False 

# --- æ ¸å¿ƒç®—æ³• ---
def get_theoretical_E(t, tau, N):
    if N < 1: N = 1
    if tau == 0: return np.zeros_like(t)
    with np.errstate(divide='ignore', invalid='ignore'):
        coeff = (N**N) / (tau**N * gamma(N))
        term = t**(N-1)
        exp_term = np.exp(-N * t / tau)
        E = coeff * term * exp_term
    E[np.isnan(E)] = 0
    return E

def sample_dataframe(df, num_points=25):
    if len(df) <= num_points: return df
    indices = np.linspace(0, len(df) - 1, num_points, dtype=int)
    indices = sorted(list(set(indices)))
    return df.iloc[indices].copy()

def process_uploaded_file(uploaded_file, col_target, label):
    try:
        # å°è¯•è¯»å–ä¸åŒç¼–ç 
        try:
            df = pd.read_csv(uploaded_file, delimiter=';', encoding='utf-8')
        except:
            uploaded_file.seek(0)
            df = pd.read_csv(uploaded_file, delimiter=';', encoding='gbk')
            
        # å¦‚æœåˆ†å·åˆ†éš”å¤±è´¥ï¼Œå°è¯•é€—å·
        if len(df.columns) < 2:
            uploaded_file.seek(0)
            df = pd.read_csv(uploaded_file, delimiter=',')
            
    except Exception as e:
        return None, None, None, f"è¯»å–å¤±è´¥: {e}"

    # 1. è·å–æ—¶é—´åˆ—
    time_col = df.columns[0]
    try:
        df['Time_Obj'] = pd.to_datetime(df[time_col])
    except:
        df['Time_Obj'] = pd.to_datetime(df[time_col], dayfirst=True, errors='coerce')

    start_t = df['Time_Obj'].iloc[0]
    t_arr = (df['Time_Obj'] - start_t).dt.total_seconds().values
    
    # 2. è·å–æ•°æ®åˆ—
    idx_map = {'1å·é‡œ': 1, '2å·é‡œ': 2, '3å·é‡œ': 3, '4å·é‡œ': 4}
    target_idx = -1
    
    if col_target in df.columns:
        raw_C = df[col_target].values
    else:
        for k, v in idx_map.items():
            if k in label:
                target_idx = v
                break
        if target_idx != -1 and target_idx < len(df.columns):
            raw_C = df.iloc[:, target_idx].values
        else:
            return None, None, None, f"æ‰¾ä¸åˆ°åˆ—: {col_target}"

    # 3. è®¡ç®—å‚æ•°
    baseline = raw_C[0]
    net_C = np.maximum(raw_C - baseline, 0)
    
    area = trapezoid(net_C, t_arr)
    moment_1 = trapezoid(t_arr * net_C, t_arr)
    t_mean = moment_1 / area if area != 0 else 0
    moment_2 = trapezoid(t_arr**2 * net_C, t_arr)
    variance = (moment_2 / area) - t_mean**2 if area != 0 else 0
    N_model = (t_mean**2) / variance if variance != 0 else 0
    
    E_t = net_C / area if area != 0 else np.zeros_like(net_C)
    
    # æ„å»ºè¡¨æ ¼æ•°æ®
    full_df = pd.DataFrame({
        'åŸå§‹æ—¶é—´': df[time_col],
        'æ—¶é—´ (s)': t_arr,
        'ç”µå¯¼ç‡åŸå§‹å€¼': raw_C,
        'ç”µå¯¼ç‡(å‡€)': net_C,
        'C*t': net_C * t_arr,
        'C*t^2': net_C * (t_arr**2)
    })
    sampled = sample_dataframe(full_df, 25)
    
    stats = {
        'sum_C': area, 'sum_Ct': moment_1, 'sum_Ct2': moment_2,
        't_mean': t_mean, 'variance': variance, 'N_model': N_model
    }
    return sampled, t_arr, E_t, stats

# --- ç½‘é¡µç•Œé¢ ---

st.title("âš—ï¸ åŒ–å·¥ä¸“ä¸šå®éªŒï¼šå¤šé‡œä¸²è”æµåŠ¨ç‰¹æ€§æµ‹å®š")
st.markdown("""
**ä½¿ç”¨è¯´æ˜ï¼š**
1. åœ¨å·¦ä¾§è¾“å…¥å®éªŒå‚æ•°ï¼ˆä½“ç§¯ã€æµé‡ï¼‰ã€‚
2. ä¸Šä¼ ä½ çš„ CSV æ•°æ®æ–‡ä»¶ã€‚
3. ç‚¹å‡»â€œå¼€å§‹å¤„ç†â€ï¼Œå³å¯æŸ¥çœ‹å›¾è¡¨å¹¶ä¸‹è½½ Excel æŠ¥è¡¨ã€‚
""")

with st.sidebar:
    st.header("âš™ï¸ 1. å‚æ•°è®¾ç½®")
    vol_input = st.number_input("æœ‰æ•ˆä½“ç§¯ V (mL)", value=1040.0)
    flow_input = st.number_input("æµé‡ Q (mL/min)", value=225.0)
    
    theo_tau = (vol_input / flow_input) * 60
    st.success(f"ç†è®ºåœç•™æ—¶é—´ Ï„ = {theo_tau:.2f} s")
    
    st.divider()
    
    st.header("ğŸ“‚ 2. ä¸Šä¼ æ•°æ®")
    file_600 = st.file_uploader("600 rpm æ•°æ® (å¿…é¡»)", type=['csv'])
    file_300 = st.file_uploader("300 rpm æ•°æ® (å¯é€‰)", type=['csv'])
    file_0 = st.file_uploader("0 rpm æ•°æ® (å¯é€‰)", type=['csv'])
    
    process_btn = st.button("ğŸš€ å¼€å§‹å¤„ç†", type="primary")

if process_btn:
    if not file_600:
        st.error("âŒ è¯·è‡³å°‘ä¸Šä¼  600 rpm çš„æ•°æ®æ–‡ä»¶ï¼")
    else:
        # å†…å­˜ä¸­åˆ›å»º Excel
        output = io.BytesIO()
        writer = pd.ExcelWriter(output, engine='xlsxwriter')
        results_cache = {}
        
        # ä»»åŠ¡æ¸…å•
        tasks = [
            (file_600, '1#é‡œç”µå¯¼ç‡å€¼', 1, '1å·é‡œ (600 rpm)', '600rpm_1'),
            (file_600, '2#é‡œç”µå¯¼ç‡å€¼', 2, '2å·é‡œ (600 rpm)', '600rpm_2'),
            (file_600, '3#é‡œç”µå¯¼ç‡å€¼', 3, '3å·é‡œ (600 rpm)', '600rpm_3'),
            (file_600, '4#é‡œç”µå¯¼ç‡å€¼', 4, '4å·é‡œ (600 rpm)', '600rpm_4'),
            (file_300, '1#é‡œç”µå¯¼ç‡å€¼', 1, '1å·é‡œ (300 rpm)', '300rpm_1'),
            (file_0,   '1#é‡œç”µå¯¼ç‡å€¼', 1, '1å·é‡œ (0 rpm)',   '0rpm_1')
        ]
        
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        for i, (f_obj, col, theo_N, label, sheet) in enumerate(tasks):
            if f_obj is None: continue
            
            status_text.text(f"æ­£åœ¨å¤„ç†: {label}...")
            f_obj.seek(0) # é‡ç½®æ–‡ä»¶æŒ‡é’ˆ
            
            sampled, t_full, E_full, stats = process_uploaded_file(f_obj, col, label)
            
            if sampled is None:
                st.warning(f"âš ï¸ {label} å¤„ç†å¤±è´¥: {stats}")
                continue
                
            results_cache[label] = {'t': t_full, 'E': E_full, 'stats': stats}
            
            # æ ¼å¼åŒ–å°æ•°
            for c in ['æ—¶é—´ (s)', 'ç”µå¯¼ç‡åŸå§‹å€¼', 'ç”µå¯¼ç‡(å‡€)', 'C*t', 'C*t^2']:
                sampled[c] = sampled[c].apply(lambda x: round(x, 4))
            
            # æ±‡æ€»ä¿¡æ¯
            summary = pd.DataFrame([
                ['æ±‚å’Œ/ç§¯åˆ†', f"{stats['sum_C']:.2f}", '', f"{stats['sum_Ct']:.2f}", f"{stats['sum_Ct2']:.2f}"],
                ['å¹³å‡åœç•™æ—¶é—´', f"{stats['t_mean']:.2f}", 'ç†è®ºtau', f"{theo_tau:.2f}", ''],
                ['æ–¹å·®', f"{stats['variance']:.2f}", '', '', ''],
                ['æ¨¡æ‹Ÿé‡œæ•° N', f"{stats['N_model']:.2f}", 'ç†è®ºN', f"{theo_N}", '']
            ], columns=sampled.columns[:5])
            
            empty_row = pd.DataFrame([[''] * 5], columns=sampled.columns[:5])
            final_df = pd.concat([sampled, empty_row, summary], axis=0, ignore_index=True)
            final_df.to_excel(writer, sheet_name=sheet, index=False)
            
            progress_bar.progress((i + 1) / len(tasks))

        writer.close()
        status_text.text("å¤„ç†å®Œæˆï¼")
        progress_bar.progress(100)
        
        st.balloons()
        st.success("âœ… æ‰€æœ‰æ•°æ®å¤„ç†å®Œæ¯•ï¼")
        
        # --- ä¸‹è½½æŒ‰é’® ---
        col_dl, col_info = st.columns([1, 2])
        with col_dl:
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½ Excel ç»“æœè¡¨",
                data=output.getvalue(),
                file_name="å®éªŒæ•°æ®å¤„ç†ç»“æœ.xlsx",
                mime="application/vnd.ms-excel",
                type="primary"
            )

        st.divider()

        # --- å›¾è¡¨å±•ç¤ºåŒºåŸŸ ---
        tab1, tab2 = st.tabs(["ğŸ“Š è½¬é€Ÿå¯¹æ¯”åˆ†æ (å›¾5)", "ğŸ“ˆ å„é‡œè¯¦ç»†åˆ†å¸ƒ (å›¾1-4)"])
        
        with tab1:
            st.subheader("1å·é‡œä¸åŒè½¬é€Ÿä¸‹ E(t) æ›²çº¿å¯¹æ¯”")
            fig_comp, ax_comp = plt.subplots(figsize=(10, 5))
            
            colors = {'600': '#1f77b4', '300': '#ff7f0e', '0': '#d62728'}
            styles = {'600': '-', '300': '-.', '0': ':'}
            max_t = 0
            
            for rpm in ['600', '300', '0']:
                key = f'1å·é‡œ ({rpm} rpm)'
                if key in results_cache:
                    d = results_cache[key]
                    ax_comp.plot(d['t'], d['E'], label=f'{rpm} rpm å®æµ‹', 
                               color=colors[rpm], linestyle=styles[rpm], lw=2)
                    max_t = max(max_t, d['t'].max())
            
            if max_t > 0:
                t_ref = np.linspace(0, max_t, 500)
                E_ref = get_theoretical_E(t_ref, theo_tau, 1)
                ax_comp.plot(t_ref, E_ref, 'k--', lw=2, label=f'ç†è®ºå…¨æ··æµ (Ï„={theo_tau:.1f}s)')
            
            ax_comp.set_xlabel("æ—¶é—´ t (s)")
            ax_comp.set_ylabel("E(t)")
            ax_comp.legend()
            ax_comp.grid(True, linestyle='--', alpha=0.6)
            st.pyplot(fig_comp)
            
        with tab2:
            st.subheader("600 rpm å„é‡œåˆ†å¸ƒ")
            col1, col2 = st.columns(2)
            cols = [col1, col2, col1, col2]
            targets = [('1å·é‡œ (600 rpm)', 1), ('2å·é‡œ (600 rpm)', 2),
                       ('3å·é‡œ (600 rpm)', 3), ('4å·é‡œ (600 rpm)', 4)]
            
            for i, (key, theo_N) in enumerate(targets):
                if key in results_cache:
                    with cols[i]:
                        d = results_cache[key]
                        fig, ax = plt.subplots(figsize=(5, 3))
                        ax.plot(d['t'], d['E'], label='å®æµ‹')
                        t_ref = np.linspace(0, d['t'].max(), 500)
                        E_theo = get_theoretical_E(t_ref, d['stats']['t_mean'], theo_N)
                        ax.plot(t_ref, E_theo, 'k--', label=f'ç†è®ºN={theo_N}')
                        
                        # â–¼â–¼â–¼ é‡ç‚¹æ˜¯ä¸‹é¢è¿™ä¸€è¡Œï¼Œå¿…é¡»æ˜¯ä¸€æ•´è¡Œï¼Œä¸èƒ½æ–­å¼€ â–¼â–¼â–¼
                        ax.set_title(f"{key} (N={d['stats']['N_model']:.2f})", fontsize=10)
                        
                        ax.legend(fontsize=8)
                        st.pyplot(fig)

# ==========================================
# ğŸ‘† Python ä»£ç ç»“æŸ
# ==========================================
`
        },
      }, document.getElementById("root"));
    </script>
  </body>
</html>